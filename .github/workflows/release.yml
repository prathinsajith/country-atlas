name: Release

on:
    workflow_dispatch: # Manual trigger from GitHub Actions tab
    push:
        tags:
            - 'v*' # Trigger automatically on version tags like v1.1.0

jobs:
    # -----------------------------
    # JOB 1: Publish to public npm
    # -----------------------------
    publish-npm:
        name: Publish to npm
        runs-on: ubuntu-latest
        permissions:
            contents: write
            id-token: write

        steps:
            # Checkout repository with full history for tags
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # Cache npm dependencies to speed up workflow
            - name: Cache npm
              uses: actions/cache@v3
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-

            # Setup Node.js
            - name: Use Node.js 20.x
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  registry-url: 'https://registry.npmjs.org'

            # Optional: dynamically set package name if needed
            # - name: Set package name (optional)
            #   run: npm pkg set name=country-atlas

            # Install dependencies
            - name: Install dependencies
              run: npm ci

            # Run lint (non-blocking)
            - name: Run Lint
              run: npm run lint || true

            # Run tests (blocking)
            - name: Run Tests
              run: npm test

            # Compile TypeScript to production-ready JavaScript
            - name: Build
              run: npm run build --if-present

            # Publish to npm with public access and secure provenance
            - name: Publish to npm
              run: npm publish --access public --provenance
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    # ----------------------------------------
    # JOB 2: Publish to GitHub Packages (Scoped)
    # ----------------------------------------
    publish-gpr:
        name: Publish to GitHub Packages
        runs-on: ubuntu-latest
        permissions:
            contents: write
            packages: write

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # Cache npm dependencies
            - name: Cache npm
              uses: actions/cache@v3
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-

            # Setup Node.js
            - name: Use Node.js 20.x
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  registry-url: 'https://npm.pkg.github.com'
                  scope: '@prathinsajith'

            # Set scoped package name dynamically
            - name: Set scoped package name
              run: npm pkg set name=@prathinsajith/country-atlas

            # Install dependencies
            - name: Install dependencies
              run: npm ci

            # Build (optional)
            - name: Build
              run: npm run build --if-present

            # Publish to GitHub Packages using a PAT
            - name: Publish to GitHub Packages
              run: npm publish
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_GITHUB_TOKEN }}

    # --------------------------------
    # JOB 3: Create GitHub Release
    # --------------------------------
    create-release:
        name: Create GitHub Release
        needs: [publish-npm, publish-gpr]
        runs-on: ubuntu-latest
        permissions:
            contents: write # Required to create release and upload assets

        steps:
            # Step 1: Download the repository code
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # Step 2: Generate Release notes and create the GitHub Release
            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  generate_release_notes: true # Auto-extract notes from commit history
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
